#!/usr/bin/env php
<?php

/*
 * This file is part of Phunkie, library with functional structures for PHP.
 *
 * (c) Marcello Duarte <marcello.duarte@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

use Phunkie\Console\Types\ReplSession;
use Phunkie\Effect\IO\IO;
use Phunkie\Effect\IO\IOApp;
use function Phunkie\Console\Repl\replLoop;
use function Phunkie\Console\Functions\{setColors, printBanner, loadHistory, saveHistory};

(function (){
    $autoloadPaths = [
        __DIR__ . '/../vendor/autoload.php', // Local development (console project)
        dirname(__DIR__, 3) . '/autoload.php', // Installed as dependency (vendor/phunkie/console/bin/phunkie -> vendor/autoload.php)
        dirname(__DIR__, 4) . '/autoload.php', // Global install sometimes puts bin deeper?
        getcwd() . '/vendor/autoload.php' // Running from project root
    ];

    $autoloaded = false;
    foreach ($autoloadPaths as $autoloadPath) {
        if (file_exists($autoloadPath)) {
            require_once $autoloadPath;
            $autoloaded = true;
            break;
        }
    }

    if (!$autoloaded) {
        fwrite(STDERR, "Error: Could not find autoloader. Please run 'composer install'.\n");
        exit(1);
    }

    class PhunkieConsole extends IOApp {
        public function run(?array $args = []): IO
        {
            // Parse command-line arguments
            $colorEnabled = $this->hasColorFlag($args);

            // Create initial session
            $initialSession = ReplSession::empty();
            $pair = setColors($colorEnabled)->run($initialSession);
            $session = $pair->_1;

            // Load command history from previous sessions
            // Print banner and start REPL loop
            return loadHistory()
                ->flatMap(fn() => printBanner($colorEnabled))
                ->flatMap(fn() => replLoop($session));
        }

        private function hasColorFlag(?array $args): bool
        {
            return $args !== null && in_array('-c', $args);
        }
    }

    // Setup signal handlers for graceful exit (Ctrl-C)
    if (function_exists('pcntl_signal')) {
        // Enable async signals so handlers are called automatically
        pcntl_async_signals(true);

        pcntl_signal(SIGINT, function() {
            // Save history before exiting
            saveHistory()->unsafeRun();
            echo "\n\nbye \\o\n";
            exit(0);
        });
    }

    // Register shutdown function to save history on normal exit
    register_shutdown_function(function() {
        saveHistory()->unsafeRun();
    });

    $args = $_SERVER['argv'];
    $app = null;

    if (isset($args[1]) && !str_starts_with($args[1], '-')) {
        $className = $args[1];

        // Try to load the class file directly if it exists (for dynamically created files)
        // This handles cases where composer's autoloader cache doesn't see new files
        // Convert namespace to path, handling the Tests -> tests directory mapping
        $classFile = str_replace('\\', '/', $className) . '.php';
        $testsRelativePath = str_replace('Tests/', '', $classFile);

        $possiblePaths = [
            // Most likely: tests directory with lowercase 't' (Linux/CI compatible)
            getcwd() . '/tests/' . $testsRelativePath,
            __DIR__ . '/../tests/' . $testsRelativePath,
            // Also check uppercase Tests for compatibility
            getcwd() . '/' . $classFile,
            __DIR__ . '/../' . $classFile,
        ];

        $fileLoaded = false;
        foreach ($possiblePaths as $path) {
            if (file_exists($path) && !class_exists($className, false)) {
                try {
                    require_once $path;
                    $fileLoaded = true;
                } catch (\Throwable $e) {
                    echo "[DEBUG] Error loading $path: " . get_class($e) . ": " . $e->getMessage() . "\n";
                }
                break;
            }
        }

        // Debug: check class status after loading attempt
        $classExists = class_exists($className, true);
        $isIOApp = $classExists && is_subclass_of($className, IOApp::class);

        if (!$classExists) {
            echo "[DEBUG] Class $className not found after loading attempt. fileLoaded=$fileLoaded\n";
            echo "[DEBUG] Checked paths:\n";
            foreach ($possiblePaths as $path) {
                echo "[DEBUG]   $path exists=" . (file_exists($path) ? 'yes' : 'no') . "\n";
            }
        }

        if ($classExists && $isIOApp) {
            try {
                $app = new $className();
            } catch (\Throwable $e) {
                echo "[DEBUG] Error instantiating $className: " . get_class($e) . ": " . $e->getMessage() . "\n";
            }
        } elseif ($classExists && !$isIOApp) {
            echo "[DEBUG] Class $className exists but is not an IOApp\n";
        }
    }

    if ($app === null) {
        if (isset($className)) {
            echo "[DEBUG] Falling back to PhunkieConsole (requested class: $className)\n";
        }
        $app = new PhunkieConsole();
    }

    try {
        $app->run($args)->unsafeRun();
    } catch (\Throwable $e) {
        echo "[DEBUG] Exception during run: " . get_class($e) . ": " . $e->getMessage() . "\n";
        echo "[DEBUG] In " . $e->getFile() . ":" . $e->getLine() . "\n";
        exit(1);
    }
})();


